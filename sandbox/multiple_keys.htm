<html>
  <head>
    <script src="../src/js/openpgp.min.js"></script>
    <script src="../src/js/jquery.min.js"></script>
    <style>
      pre {border: 1px solid #aaa; background: #fafafa; padding: 20px; margin: 20px; }
    </style>
  </head>
  <body>
    <h1>Multiple key encryption/decryption</h1>
    <pre id="prv_1"></pre>
    <pre id="prv_2"></pre>
    <pre id="pub_1"></pre>
    <pre id="pub_2"></pre>
    <pre id="msg_plain">hello, this is my message</pre>
    <pre id="msg_encrypted"></pre>
    <pre id="msg_decrypted_1"></pre>
    <pre id="msg_decrypted_2"></pre>
    <script>

      function create_keypair(n, callback) {
        console.log('create_keypair ' + n);
        openpgp.generateKeyPair({numBits: 1024, userId: 'Test' + n + ' <test' + n + '@email.com>', passphrase: ''}).then(function(keypair){
          $('#prv_' + n).text(keypair.privateKeyArmored);
          $('#pub_' + n).text(keypair.publicKeyArmored);
          callback();
        }).catch(function(error) {
          $('#prv_' + n).text(error);
          $('#pub_' + n).text(error);
          console.log(error);
        });
      }

      function encrypt(callback){
        var pubkeys = [];
        pubkeys = pubkeys.concat(openpgp.key.readArmored($('#pub_1').text()).keys);
        pubkeys = pubkeys.concat(openpgp.key.readArmored($('#pub_2').text()).keys);
        openpgp.encryptMessage(pubkeys, $('#msg_plain').text()).then(callback, function(error){
          console.log('error encrypting');
          console.log(error);
        });
      }

      function decrypt(n, callback){
        console.log('decrypt ' + n);
        var private_key = openpgp.key.readArmored($('#prv_' + n).text()).keys[0];
        var pgp_message = openpgp.message.readArmored($('#msg_encrypted').text());
        openpgp.decryptMessage(private_key, pgp_message).then(function(plaintext) {
          $('#msg_decrypted_' + n).text(plaintext);
          callback();
        }).catch(function(error) {
          $('#msg_decrypted_' + n).text(error);
          console.log('error decrypt ' + n);
          console.log(error);
        });

      }

      create_keypair(1, function(){
        create_keypair(2, function(){
          encrypt(function(encrypted){
            $('#msg_encrypted').text(encrypted);
            decrypt(1, function(){
              decrypt(2, function(){
                console.log('done');
              })
            });
          });
        });
      });

    </script>
  </body>
</html>
